#
#  idave2/mediawiki image generator
#
#  See '.env' for environment defaults.
#
####-####+####-####+####-####+####-####+####-####+####-####+####-####+####

# FROM mediawiki:1.39 AS view
# 1.39 manual installer (maintenance/install.php) may be broken. Try newer.
FROM mediawiki:1.40 AS view

# Who keeps mumbling "Less is more, less is more?"
# This layer helps with debugging and can be removed.
RUN set -eux && apt update && apt install -y less iputils-ping

# Configurable --build-arg's.
ARG MW_ADMINISTRATOR MW_PASSWORD MW_DB_DATABASE MW_DB_USER MW_DB_PASSWORD

# Use a distinct work area. Go to your room.
RUN set -eux && mkdir DockerWiki; \
    echo "$MW_DB_PASSWORD" > DockerWiki/dbpassfile; \
    echo "$MW_PASSWORD" > DockerWiki/passfile;

# It seems that no mariadb network is available during mediawiki builds,
# which sounds about right, so we cannot run maintenance/install.php here,
# so we will do it in cake.sh right after this (unconfigured) mediawiki
# image is launched in a new wiki-view-1 container. Neato.

# maintenance/run CommandLineInstaller --dbtype=mysql --dbserver='wiki-data-1' \
#   --dbname=mediawiki --dbuser=wikiDBA --dbpassfile='DockerWiki/dbpassfile' \
#   --passfile='DockerWiki/passfile' --scriptpath='' \
#   --server="http://localhost:8080" DockerWiki WikiAdmin

# Install MediaWiki. Installer runs --env-checks before proceeding.
# RUN set -eux; \
#   php maintenance/install.php \
#     --dbname="$MW_DB_DATABASE"  \
#     --dbpassfile="DockerWiki/dbpassfile" \
#     --dbserver="127.0.0.1" \
#     --dbuser="$MW_DB_USER" \
#     --globals \
#     --passfile="DockerWiki/passfile" \
#     --scriptpath="" \
#     --server="http://localhost:8080" \
#     DockerWiki \
#     WikiAdmin

# Copy LocalSettings.php generated by MediaWiki installation wizard.
# COPY LocalSettings.php /var/www/html/

# --- not sure next 2 lines remain applicable, 1.40-maintenance/run worked,
# --- so hooray for mediawiki people and small animals.
# Cache must be disabled for unique secret key generation below.
# Use --no-cache-filter when available to cache this 5 second layer.

# Until "docker build --no-cache-filter" is available, use --no-cache to
# prevent this secret key from being cached.
# RUN set -eux; \
#   secretKey=$(perl -we "print map { ('0'..'9','a'..'f')[int(rand(16))] } 1..64"); \
#   # echo KEY IS $secretKey HAVE A NICE DAY; \
#   perl -i.bak -pwe " \
#     s|%%wgSecretKey%%|$secretKey|; \
#     s|%%wgDBname%%|$MW_DB_DATABASE|; \
#     s|%%wgDBuser%%|$MW_DB_USER|; \
#     s|%%wgDBpassword%%|$MW_DB_PASSWORD|; \
#   " LocalSettings.php

####-####+####-####+####-####+####-####+####-####+####-####+####-####+####
#
#  The initial database -- mariadb/70-initdb.sql.gz -- was created after
#  manually running the MediaWiki update script,
#
#    $ php maintenance/update.php.
#
#  This script does "post installation" for whatever extensions are
#  activated; in our case, it creates table mediawiki.oathauth_users
#  for TOTP fun. Once initial database is checked in, this step does
#  not need repeating.
#
#  Original MariaDB entry point remains active.
