# DockerWiki

This project is an implementation of the multi-container pattern outlined
in Docker Docs'
[Getting Started](https://docs.docker.com/get-started/07_multi_container/)
guide.
The audience might be developers or students learning Docker or researching
this environment for, I don't know, for the next Mars expedition.
If you want to use Docker + LAMP for business, please find similar projects
from [Bitnami](https://hub.docker.com/r/bitnami/mediawiki) or organizations
whose context includes strong security, support, and all the things a
business needs to run.

A summary of what is here:

- `bin/actionAPI.sh`: MediaWiki (MW) action API tests
- `bin/backrest.sh`: simple backup and restore starter kit
- `bin/cake.sh`: build and run makefile for `docker`
- `.env`: build and runtime configuration variables
- `.envData`: just MariaDB runtime environment
- `compose.yaml`: build and run makefile for `docker compose`
- `config.yaml`: run-only compose file for Docker Hub launch
- `setEnv.sh`: shortcuts to simplify development

## Naming Conventions

`compose.yaml` service names are invariant in the sense that you cannot
replace them with a variable, like `${VIEW_SERVICE_NAME}`, without generating
a validation error from `docker compose`:
```
name: wiki
services:
  view: ...
  data: ...
networks:
  net:
volumes:
  data:
```
Given these names, `docker compose` then decorates them with project name
and possibly an index if there can be multiple instances. So we get
`wiki-view-1` and `wiki-data-1` for generated containers, `wiki_net` and
`wiki_data` for generated network and volume.

In order to simplify documentation and examples and hopefully recall, the
Dockerfile builder `cake.sh` (which does not use `compose.yaml`) emulates
this convention by default.

## Builds

If you source `setEnv.sh`,
```
$ source setEnv.sh
alias br="bin/backrest.sh"
alias cake="bin/cake.sh"
alias d=docker
alias dc="docker compose"
```
then you can build one or both images using Docker files,
```
$ cake     # create everything
$ cake -k  # destroy everything
```
or you can build and run their Docker Compose stack-of-images,
```
$ dc up -d [--build]      # create everything
$ dc down -v --rmi local  # destroy almost everything
```
Remember to backup new important data before (accidentally) blowing away its volume!

## Backups

`backrest.sh` backs up and restores two items: the MariaDB database and the MediaWiki images directory tree. It's default configuration is near the top of `.env`:
```
DATA_CONTAINER=wiki-data-1
VIEW_CONTAINER=wiki-view-1
TEMP_DIR=/tmp/DockerWiki
```
These are the default container names generated by `docker compose`. If you build with Dockerfiles instead (i.e., using `cake.sh`), your container names differ and you can specify them explicitly,
```
$ br -b -d data -v view  # Backup containers named 'data' and 'view'
```
How about `~/.dockerwiki/config` overrides?
```
$ br --backup wiki-data-1  # dumps DB into ./all-databases.sql
```
A thorough restore test might include completely removing Docker Desktop,
or at least removing DockerWiki and its volumes (whose data lives in
Docker-managed storage). Then from nothing to complete restoration
using long-form options,
```
$ docker compose up --detach  # Restore DockerWiki.
$ backrest.sh --restore       # Restore database and images.
```
or
```
$ cake.sh
$ backrest.sh --restore --data-container data --view-container view
```

## OATH and OAuth

[Open Authentication](https://en.wikipedia.org/wiki/Initiative_for_Open_Authentication)
(i.e., two-factor login) works and may be activated in user preferences.
To avoid timeout during initial synchronization, you may want to plan to
take a screenshot of the long list of recovery keys. Then you can save them
properly once initial sync completes. Also see MediaWiki's
[documentation](https://www.mediawiki.org/wiki/Extension:OATHAuth).

[Open Authorization](https://en.wikipedia.org/wiki/OAuth) may not be
finished until [MediaWiki 1.41](https://www.mediawiki.org/wiki/Extension:OAuth).
This project uses plain bot passwords for API testing.

---

Latest images are pushed to [Docker Hub](https://hub.docker.com/u/idave2) and no CI is configured (yet).

Docker is fun; five stars to the team.

> "Yes, we are *very* good."<br/>
> &nbsp;&nbsp;&nbsp; â€“ Top Gun: Maverick, community edition
