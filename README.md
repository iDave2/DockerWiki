# DockerWiki

This project is an implementation of the multi-container pattern outlined
in Docker Docs'
[Getting Started](https://docs.docker.com/get-started/07_multi_container/)
guide.
It targets developers and students.
To use Docker + LAMP for business, please find similar projects
from [Bitnami](https://hub.docker.com/r/bitnami/mediawiki) or organizations
whose context includes strong security, support, and all the things a
business needs to run.

A summary of what is here:

- `bin/actionAPI.sh`: MediaWiki (MW) action API tests
- `bin/backrest.sh`: simple backup and restore starter kit
- `bin/cake.sh`: build script to *make* and unmake artifacts
- `.env`: build and runtime configuration variables
- `compose.yaml`: `docker compose` launch instructions
- `config.yaml`: to be deprecated away
- `setEnv.sh`: shortcuts to simplify development and test

## Builds

`source setEnv.sh` for a build script that runs anywhere,
```bash
alias cake="/absolute/path/to/bin/cake.sh"
alias dc="docker compose"
```
When run from mariadb or mediawiki directories, `cake` only builds that image.
When run from the parent of those folders &ndash; that is, the project root
&ndash; `cake` builds both images:
```bash
$ cake      # create everything
$ cake -c   # destroy containers and images
$ cake -cc  # also remove volumes and networks
```
Build instructions were removed from `compose.yaml` when post-install steps
became complex. `docker compose` still launches DockerWiki fine,
```bash
$ dc up -d                # create everything
$ dc down -v --rmi local  # destroy almost everything
```
Remember to backup important data before (accidentally) removing its volume!

## Backups

`backrest.sh` backs up and restores two items: the MariaDB database and the MediaWiki images directory tree. It's default configuration is near the top of `.env`:
```
DATA_CONTAINER=wiki-data-1
VIEW_CONTAINER=wiki-view-1
TEMP_DIR=/tmp/DockerWiki
```
These are the default container names generated by `docker compose`. If you build with Dockerfiles instead (i.e., using `cake.sh`), your container names differ and you can specify them explicitly,
```
$ br -b -d data -v view  # Backup containers named 'data' and 'view'
```
How about `~/.dockerwiki/config` overrides?
```
$ br --backup wiki-data-1  # dumps DB into ./all-databases.sql
```
A thorough restore test might include completely removing Docker Desktop,
or at least removing DockerWiki and its volumes (whose data lives in
Docker-managed storage). Then from nothing to complete restoration
using long-form options,
```
$ docker compose up --detach  # Restore DockerWiki.
$ backrest.sh --restore       # Restore database and images.
```
or
```
$ cake.sh
$ backrest.sh --restore --data-container data --view-container view
```

## OATH and OAuth

[Open Authentication](https://en.wikipedia.org/wiki/Initiative_for_Open_Authentication)
(i.e., two-factor login) works and may be activated in user preferences.
To avoid timeout during initial synchronization, you may want to plan to
take a screenshot of the long list of recovery keys. Then you can save them
properly once initial sync completes. Also see MediaWiki's
[documentation](https://www.mediawiki.org/wiki/Extension:OATHAuth).

[Open Authorization](https://en.wikipedia.org/wiki/OAuth) may not be
finished until [MediaWiki 1.41](https://www.mediawiki.org/wiki/Extension:OAuth).
This project uses plain bot passwords for API testing.

---

Latest images are pushed to [Docker Hub](https://hub.docker.com/u/idave2) and no CI is configured (yet).

Docker is fun; five stars to the team.

> "Yes, we are *very* good."<br/>
> &nbsp;&nbsp;&nbsp; â€“ Top Gun: Maverick, community edition
