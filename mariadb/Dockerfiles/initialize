#
#  idave2/mariadb Dockerfile - initialize
#
#  Also see:
#    https://hub.docker.com/_/mariadb/;
#    https://mariadb.com/kb/en/mariadb-server-docker-official-image-environment-variables/;
#
####-####+####-####+####-####+####-####+####-####+####-####+####-####+####

FROM mariadb:11.6 AS data

# Limit root to local access?
ARG MARIADB_ROOT_HOST
ENV MARIADB_ROOT_HOST=$MARIADB_ROOT_HOST

# MariaDB kindly sets up a user and database for us.
# Configure something for MediaWiki.
ARG MARIADB_DATABASE
ENV MARIADB_DATABASE=$MARIADB_DATABASE
ARG MARIADB_USER
ENV MARIADB_USER=$MARIADB_USER

# Place custom initialization steps inside /docker-entrypoint-initdb.d.
# See backrest.sh --restore for practical use of this convenient feature.
COPY ./20-noop.sh /docker-entrypoint-initdb.d/

# Copy secret passwords into container's /root for DB initialization.
ARG HOME=/root
RUN --mount=type=secret,id=mariadb-root-password-file \
    --mount=type=secret,id=mariadb-password-file \
    set -eu && \
    cp /run/secrets/mariadb-root-password-file "$HOME/mariadb-root-password-file" && \
    cp /run/secrets/mariadb-password-file "$HOME/mariadb-password-file"
ENV MARIADB_ROOT_PASSWORD_FILE="$HOME/mariadb-root-password-file"
ENV MARIADB_PASSWORD_FILE="$HOME/mariadb-password-file"

# Original MariaDB entry point remains active.
